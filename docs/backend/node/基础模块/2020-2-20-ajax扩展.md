---
title: "Ajaxæ‰©å±•"
date: 2020-02-20
sidebar: 'auto'
categories:
- BackEnd
tags:
- nodeåŸºç¡€æ¨¡å—
---











# `Ajax` æ‰©å±•

## å®¢æˆ·ç«¯æ¨¡æ¿å¼•æ“

### ä½œç”¨

ä½¿ç”¨æ¨¡æ¿å¼•æ“æä¾›çš„æ¨¡æ¿è¯­æ³•ï¼Œå¯ä»¥å°†æ•°æ®å’Œ HTML æ‹¼æ¥èµ·æ¥ã€‚[å®˜æ–¹åœ°å€](https://aui.github.io/art-template/zh-cn/index.html)

### ä½¿ç”¨æ­¥éª¤

ä¸‹è½½ `art-template` æ¨¡æ¿å¼•æ“åº“æ–‡ä»¶å¹¶åœ¨ HTML é¡µé¢ä¸­å¼•å…¥åº“æ–‡ä»¶

```html
<script src="./js/template-web.js"></script>
```

å‡†å¤‡ `art-template` æ¨¡æ¿

```html
<script id="tpl" type="text/html">
    <div class="box"></div>
</script>
```

å‘Šè¯‰æ¨¡æ¿å¼•æ“å°†å“ªä¸€ä¸ªæ¨¡æ¿å’Œå“ªä¸ªæ•°æ®è¿›è¡Œæ‹¼æ¥

```js
var html = template('tpl', { 
    username: 'zhangsan', 
    age: '20'
})
```

 å°†æ‹¼æ¥å¥½çš„`html`å­—ç¬¦ä¸²æ·»åŠ åˆ°é¡µé¢ä¸­

```js
document.getElementById('container').innerHTML = html
```

é€šè¿‡æ¨¡æ¿è¯­æ³•å‘Šè¯‰æ¨¡æ¿å¼•æ“ï¼Œæ•°æ®å’Œ`html`å­—ç¬¦ä¸²è¦å¦‚ä½•æ‹¼æ¥

```html
<script id="tpl" type="text/html">
    <div class="box"> {{ username }} </div>
</script>
```

### å¼€æ”¾å¤–éƒ¨å˜é‡

å°†å¤–éƒ¨å‡½æ•°å¼€æ”¾åˆ°æ¨¡æ¿ä¸­æ¥ä½¿ç”¨ã€‚

**ç¤ºä¾‹**

**è®¾ç½®**

```js
//å‘æ¨¡æ¿ä¸­å¼€æ”¾å¤–éƒ¨å˜é‡
template.defaults.imports.dateFormart = function dateFormart(date) {
    let y = date.substr(0, 4)
    let mon = date.substr(4, 2)
    let d = date.substr(6, 2)
    let h = date.substr(8, 2)
    let min = date.substr(10, 2)
    let s = date.substr(12, 2)
    return `${y}å¹´${mon}æœˆ${d}æ—¥ ${h}æ—¶${min}åˆ†${s}ç§’`
}

```

**åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨**

```html
<script id="tpl" type="text/html">
    <tr>
        <th>æ—¶é—´</th>
        <th>æ¸©åº¦</th>
        <th>å¤©æ°”</th>
        <th>é£å‘</th>
        <th>é£åŠ›</th>
    </tr>
{{each weathers}}
    <tr>
        <th>{{dateFormart($value.update_time)}}</th> //ä½¿ç”¨å¼€æ”¾çš„å˜é‡
        <th>{{$value.degree}}</th>
        <th>{{$value.weather_short}}</th>
        <th>{{$value.wind_direction}}</th>
        <th>{{$value.wind_power}}</th>
    </tr>
{{/each}}
</script>
```



## æ¡ˆä¾‹

### éªŒè¯é‚®ç®±å”¯ä¸€æ€§

#### æ•ˆæœ

<img src="https://my-blog-leo.oss-cn-chengdu.aliyuncs.com/31.webp"  >

#### æ­¥éª¤

è·å–æ–‡æœ¬æ¡†å¹¶ä¸ºå…¶æ·»åŠ ç¦»å¼€ç„¦ç‚¹äº‹ä»¶

ç¦»å¼€ç„¦ç‚¹æ—¶ï¼Œæ£€æµ‹ç”¨æˆ·è¾“å…¥çš„é‚®ç®±åœ°å€æ˜¯å¦ç¬¦åˆè§„åˆ™

å¦‚æœä¸ç¬¦åˆè§„åˆ™ï¼Œé˜»æ­¢ç¨‹åºå‘ä¸‹æ‰§è¡Œå¹¶ç»™å‡ºæç¤ºä¿¡æ¯

å‘æœåŠ¡å™¨ç«¯å‘é€è¯·æ±‚ï¼Œæ£€æµ‹é‚®ç®±åœ°å€æ˜¯å¦è¢«åˆ«äººæ³¨å†Œ

æ ¹æ®æœåŠ¡å™¨ç«¯è¿”å›å€¼å†³å®šå®¢æˆ·ç«¯æ˜¾ç¤ºä½•ç§æç¤ºä¿¡æ¯

**å®¢æˆ·ç«¯é¡µé¢**

```html
<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>éªŒè¯é‚®ç®±åœ°å€æ˜¯å¦å·²ç»æ³¨å†Œ</title>
	<link rel="stylesheet" href="/assets/bootstrap/dist/css/bootstrap.min.css">
	<style type="text/css">
		p:not(:empty) {
			padding: 15px;
		}

		.container {
			padding-top: 100px;
		}
	</style>
</head>

<body>
	<div class="container">
		<div class="form-group">
			<label>é‚®ç®±åœ°å€</label>
			<input type="email" class="form-control" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" id="email">
		</div>
		<!-- é”™è¯¯ bg-danger æ­£ç¡® bg-success -->
		<p id="info" style="text-align: center;"></p>
	</div>
	<script src="/js/ajax.js"></script>
	<script>

		let btn = document.getElementById('email')
		let info = document.getElementById('info')
		btn.onblur = function () {
			let email = this.value

			var myreg = /^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/

			if (!myreg.test(email)) {
				info.innerHTML = 'æ ¼å¼ä¸ç¬¦åˆè¦æ±‚'
				info.className = 'bg-danger'
				return
			}

			var xhr = new XMLHttpRequest()
			var params = `email=${email}`
			xhr.open('get', `http://localhost:3000/verifyEmailAdress?${params}`)
			xhr.send()
			xhr.onload = function () {
				let responseText = xhr.responseText
				let contentType = xhr.getResponseHeader('Content-Type')
				
				if (contentType.includes('application/json')) {
					responseText = JSON.parse(responseText)
				}
				
				if (xhr.status == 200) {
					info.className = 'bg-success'
				} else {
					info.className = 'bg-danger'
				} 

				info.innerHTML = responseText.message
			}

		}
	</script>
</body>

</html>
```

**æœåŠ¡ç«¯å¤„ç†**

```js
// é‚®ç®±åœ°å€éªŒè¯
app.get('/verifyEmailAdress', (req, res) => {
	// æ¥æ”¶å®¢æˆ·ç«¯ä¼ é€’è¿‡æ¥çš„é‚®ç®±åœ°å€
	const email = req.query.email
	// åˆ¤æ–­é‚®ç®±åœ°å€æ³¨å†Œè¿‡çš„æƒ…å†µ
	if (email == 'itheima@itcast.cn') {
		// è®¾ç½®httpçŠ¶æ€ç å¹¶å¯¹å®¢æˆ·ç«¯åšå‡ºå“åº”
		res.status(400).send({message: 'é‚®ç®±åœ°å€å·²ç»æ³¨å†Œè¿‡äº†, è¯·æ›´æ¢å…¶ä»–é‚®ç®±åœ°å€'})
	} else {
		// é‚®ç®±åœ°å€å¯ç”¨çš„æƒ…å†µ
		// å¯¹å®¢æˆ·ç«¯åšå‡ºå“åº”
		res.send({message: 'æ­å–œ, é‚®ç®±åœ°å€å¯ç”¨'})
	} 
})
```



### æœç´ æ¡†æç¤º

#### æ•ˆæœ

<img src="https://my-blog-leo.oss-cn-chengdu.aliyuncs.com/32.gif"  >

#### æ­¥éª¤

è·å–æœç´¢æ¡†å¹¶ä¸ºå…¶æ·»åŠ ç”¨æˆ·è¾“å…¥äº‹ä»¶

è·å–ç”¨æˆ·è¾“å…¥çš„å…³é”®å­—

å‘æœåŠ¡å™¨ç«¯å‘é€è¯·æ±‚å¹¶æºå¸¦å…³é”®å­—ä½œä¸ºè¯·æ±‚å‚æ•°

å°†å“åº”æ•°æ®æ˜¾ç¤ºåœ¨æœç´¢æ¡†åº•éƒ¨

**å®¢æˆ·ç«¯**

```html
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>æœç´¢æ¡†è¾“å…¥æ–‡å­—è‡ªåŠ¨æç¤º</title>
	<link rel="stylesheet" href="/assets/bootstrap/dist/css/bootstrap.min.css">
	<style type="text/css">
		.container {
			padding-top: 150px;
		}
		.list-group {
			display: none;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="form-group">
			<input type="text" class="form-control" placeholder="è¯·è¾“å…¥æœç´¢å…³é”®å­—" id="search" autocomplete="off">
			<ul  class="list-group" id="list-box">
				<li>huihuiho</li>
			</ul>
		</div>
	</div>
	<script src="/js/ajax.js"></script>
	<script src="/js/template-web.js"></script>
	<script id="tpl" type="text/html">
		{{each lis}}
		<li class="list-group-item">{{$value}}</li>
		{{/each}}
	</script>
	<script>
		let search  = document.getElementById('search')
		let listBox  = document.getElementById('list-box')
		search.oninput = function () {
			let queryString = search.value

			let xhr = new XMLHttpRequest()

			xhr.open('get', `http://localhost:3000/searchAutoPrompt?key=${queryString}`)

			xhr.send()

			xhr.onload = function () {
				let contentType = xhr.getResponseHeader('Content-Type')
				let responseText = xhr.responseText
				console.log(contentType)
				if (contentType.includes('application/json')) {
					responseText = JSON.parse(responseText)
				}
				console.log(responseText)
				let lis = template('tpl', { lis: responseText })
				listBox.style.display = 'block'
				listBox.innerHTML = lis

			}
		}
	</script>
</body>
</html>
```

**æœåŠ¡ç«¯**

```js
// è¾“å…¥æ¡†æ–‡å­—æç¤º
app.get('/searchAutoPrompt', (req, res) => {
    // æœç´¢å…³é”®å­—
    const key = req.query.key;
    if (!key) {
        return res.send([])
    }
    // æç¤ºæ–‡å­—åˆ—è¡¨
    const list = [
        'å¨å°‘å¤§ä¸‰åŒ38+19+20',
        'å¨å°‘é‡å›é›·éœ†ä¸»åœº',
        'å¨å°‘å“ˆç™»åˆç 80åˆ†',
        'ç¥é¾Ÿè·å¾—MVP',
        'å¨å°‘å¤ºå† ',
        'å¨å°‘éš”æ‰£è©¹å§†æ–¯',
        'å¨å°‘å‚å†›',
        'å¨å°‘å­¦ä¹ java',
        'éœ‡æƒŠï¼å¨å°‘è½¬è¡ŒIT',
        'å¨å°‘å­¦ä¹ c++',
        'å¨å°‘---p10çº§åˆ«ç¨‹åºå‘˜'
    ];
    // æœç´¢ç»“æœ
    let result = list.filter(item => item.includes(key));
    // å°†æŸ¥è¯¢ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯
    res.send(result);
})
```

#### å­˜åœ¨é—®é¢˜

å‘ä¸Šé¢é‚£æ ·ï¼Œæ¯å½“è¾“å…¥ä¸€ä¸ªå­—ç¬¦ `oninput` äº‹ä»¶å°±è§¦å‘ä¸€æ¬¡ï¼Œå°±åƒæœåŠ¡å™¨å‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œè¿™æ ·å…ˆè®©ä½ æ˜¯ä¸åˆç†çš„ã€‚

<img src="https://my-blog-leo.oss-cn-chengdu.aliyuncs.com/33.webp" width="50%">

#### è§£å†³æ–¹æ¡ˆ èŠ‚æµ

åœ¨æ¯ä¸€æ¬¡è§¦å‘ `oninput` äº‹ä»¶åæ¸…é™¤ä¸Šä¸€æ¬¡è®¾ç½®çš„å»¶æ—¶å®šæ—¶å™¨ï¼Œç„¶ååˆé‡æ–°å¼€å¯ä¸€ä¸ªæ–°çš„å»¶æ—¶å®šæ—¶å™¨ `400ms` åå‘é€è¯·æ±‚ã€‚åœ¨ `400ms` å†…è¿ç»­è§¦å‘çš„ `oninput` äº‹ä»¶æ— æ•ˆï¼ˆè®¤ä¸ºç”¨æˆ·åœ¨è¿ç»­è¾“å…¥ï¼‰ï¼Œäº‹ä»¶è§¦å‘è¶…è¿‡ `400ms` åè¿˜æ²¡æœ‰äº‹ä»¶è§¦å‘é‚£ä¹ˆè®¤ä¸ºè¿™ä¸€æ¬¡è§¦å‘äº‹ä»¶åå°±æ˜¯è¾“å…¥å®Œæˆï¼Œå¯ä»¥å‘é€è¯·æ±‚ã€‚

```js
let timer = null
let search = document.getElementById('search')
let listBox = document.getElementById('list-box')

search.oninput = function () {
    clearTimeout(timer)
    //å¼€å¯å®šæ—¶å™¨ï¼Œå»¶è¿Ÿå‘é€è¯·æ±‚
    timer = setTimeout(() => {
        let queryString = search.value
        let xhr = new XMLHttpRequest()
        if (!queryString) {
            clearTimeout(timer)
            listBox.style.display = 'none'
            return
        }
        xhr.open('get', `http://localhost:3000/searchAutoPrompt?key=${queryString}`)

        xhr.send()
        console.log('å‘é€ä¸€æ¬¡è¯·æ±‚')
        xhr.onload = function () {
            let contentType = xhr.getResponseHeader('Content-Type')
            let responseText = xhr.responseText
            if (contentType.includes('application/json')) {
                responseText = JSON.parse(responseText)
            }
            let lis = template('tpl', { lis: responseText })
            listBox.style.display = 'block'
            listBox.innerHTML = lis
        }
    },400)

}

```



### çœå¸‚åŒºä¸‰çº§è”åŠ¨

#### æ•ˆæœ

<img src="https://my-blog-leo.oss-cn-chengdu.aliyuncs.com/34.webp" >

**å®¢æˆ·ç«¯**

```js
let province = document.getElementById('province')
let citySelect = document.getElementById('city')
let areaSelect = document.getElementById('area')
//è·å–çœä»½ä¿¡æ¯
ajax({
    type: 'get',
    url: 'http://localhost:3000/province',
    success: function (result) {
        let optionsTpl = template('optionsTpl', {
            tag: 'è¯·é€‰æ‹©çœä»½',
            options: result
        })
        province.innerHTML = optionsTpl
    },
    error: function (result) {
        console.log('å¤±è´¥' + result)
    }
})

//é€‰æ‹©çœä»½åï¼Œè¯·æ±‚å¯¹åº”çš„åŸå¸‚ä¿¡æ¯
province.onchange = function () {
    let selectid = this.value
    console.log(selectid)
    if (!selectid) {
        render('optionsTpl', 'è¯·é€‰æ‹©å¿åŸ', [], areaSelect)
        render('optionsTpl', 'è¯·é€‰æ‹©åŸå¸‚', [], citySelect)
        return
    }
    ajax({
        type: 'get',
        url: `http://localhost:3000/cities`,
        data: {
            id: selectid
        },
        success: function (cities) {
            render('optionsTpl', 'è¯·é€‰æ‹©åŸå¸‚', cities, citySelect)
        },
        error: function () {

        }
    })
}

//åŸå¸‚é€‰æ‹©åï¼Œè¯·æ±‚å¿åŸä¿¡æ¯
citySelect.onchange = function () {
    let selectid = this.value
    console.log(selectid)
    if (!selectid) {
        render('optionsTpl', 'è¯·é€‰æ‹©å¿åŸ', [], areaSelect)
        return
    }
    ajax({
        type: 'get',
        url: 'http://localhost:3000/areas',
        data: {
            id: selectid
        },
        success: function (areas) {
            render('optionsTpl', 'è¯·é€‰æ‹©å¿åŸ', areas, areaSelect)
        },
        error: function () {

        }
    })
}

//æ¸²æŸ“ä¸‹æ‹‰é€‰æ‹©æ¡†çš„å‡½æ•°
function render (tplId, tag, options, container) {
    let optionsTpl = template(tplId, {tag, options})
    container.innerHTML = optionsTpl
}
```

**æœåŠ¡ç«¯**

```js
// è·å–çœä»½
app.get('/province', (req, res) => {
    res.json([{
        id: '001',
        name: 'é»‘é¾™æ±Ÿçœ'
    },{
        id: '002',
        name: 'å››å·çœ'
    },{
        id: '003',
        name: 'æ²³åŒ—çœ'
    },{
        id: '004',
        name: 'æ±Ÿè‹çœ'
    }]);
});

// æ ¹æ®çœä»½idè·å–åŸå¸‚
app.get('/cities', (req, res) => {
    // è·å–çœä»½id
    const id = req.query.id;
    console.log(id)
    // åŸå¸‚ä¿¡æ¯
    const cities = {
        '001': [{
            id: '300',
            name: 'å“ˆå°”æ»¨å¸‚'
        }, {
            id: '301',
            name: 'é½é½å“ˆå°”å¸‚'
        }, {
            id: '302',
            name: 'ç‰¡ä¸¹æ±Ÿå¸‚'
        }, {
            id: '303',
            name: 'ä½³æœ¨æ–¯å¸‚'
        }],
        '002': [{
            id: '400',
            name: 'æˆéƒ½å¸‚'
        }, {
            id: '401',
            name: 'ç»µé˜³å¸‚'
        }, {
            id: '402',
            name: 'å¾·é˜³å¸‚'
        }, {
            id: '403',
            name: 'æ”€æèŠ±å¸‚'
        }],
        '003': [{
            id: '500',
            name: 'çŸ³å®¶åº„å¸‚'
        }, {
            id: '501',
            name: 'å”å±±å¸‚'
        }, {
            id: '502',
            name: 'ç§¦çš‡å²›å¸‚'
        }, {
            id: '503',
            name: 'é‚¯éƒ¸å¸‚'
        }],
        '004': [{
            id: '600',
            name: 'å¸¸å·å¸‚'
        }, {
            id: '601',
            name: 'å¾å·å¸‚'
        }, {
            id: '602',
            name: 'å—äº¬å¸‚'
        }, {
            id: '603',
            name: 'æ·®å®‰å¸‚'
        }]
    }
    // å“åº”
    res.send(cities[id]);
});

// æ ¹æ®åŸå¸‚idè·å–å¿åŸ
app.get('/areas', (req, res) => {
    // è·å–åŸå¸‚id
    const id = req.query.id;
    // å¿åŸä¿¡æ¯
    const areas = {
        '300': [{
            id: '20',
            name: 'é“é‡ŒåŒº',
        }, {
            id: '21',
            name: 'å—å²—åŒº'
        }, {
            id: '22',
            name: 'å¹³æˆ¿åŒº',
        }, {
            id: '23',
            name: 'æ¾åŒ—åŒº'
        }],
        '301': [{
            id: '30',
            name: 'é¾™æ²™åŒº'
        }, {
            id: '31',
            name: 'é“é”‹åŒº'
        }, {
            id: '32',
            name: 'å¯Œæ‹‰å°”åŸºåŒº'
        }]
    };
    // å“åº”
    res.send(areas[id] || []);
});
```



## åŒæºæ”¿ç­–

### Ajaxè¯·æ±‚é™åˆ¶

`Ajax` åªèƒ½å‘è‡ªå·±çš„æœåŠ¡å™¨å‘é€è¯·æ±‚ã€‚æ¯”å¦‚ç°åœ¨æœ‰ä¸€ä¸ª A ç½‘ç«™ã€æœ‰ä¸€ä¸ª B ç½‘ç«™ï¼ŒA ç½‘ç«™ä¸­çš„ `HTML` æ–‡ä»¶åªèƒ½å‘ Aç½‘ç«™æœåŠ¡å™¨ä¸­å‘é€ `Ajax` è¯·æ±‚ï¼ŒB ç½‘ç«™ä¸­çš„ `HTML` æ–‡ä»¶åªèƒ½å‘ B ç½‘ç«™ä¸­å‘é€ `Ajax` è¯·æ±‚ï¼Œä½†æ˜¯ A ç½‘ç«™æ˜¯ä¸èƒ½å‘ B ç½‘ç«™å‘é€ `Ajax` è¯·æ±‚çš„ï¼ŒåŒç†ï¼ŒB ç½‘ç«™ä¹Ÿä¸èƒ½å‘ A ç½‘ç«™å‘é€ `Ajax` è¯·æ±‚ã€‚ç”±äºæµè§ˆå™¨çš„åŒæºæ”¿ç­–æ‰€ä»¥ `Ajax` ä¸èƒ½è·¨åŸŸè¯·æ±‚ã€‚

### åŒæºæ”¿ç­–æ¦‚è¿°

å¦‚æœä¸¤ä¸ªé¡µé¢æ‹¥æœ‰ç›¸åŒçš„ **åè®®**ã€**åŸŸåå’Œç«¯å£** ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªé¡µé¢å°±å±äºåŒä¸€ä¸ªæºï¼Œå…¶ä¸­åªè¦æœ‰ä¸€ä¸ªä¸ç›¸åŒï¼Œå°±æ˜¯ä¸åŒæºã€‚

```shell
http://www.example.com/dir/page.html
//ä¸ä¸Šé¢ç½‘å€å¯¹æ¯”
http://www.example.com/dir2/other.htmlï¼šåŒæº
http://example.com/dir/other.htmlï¼šä¸åŒæºï¼ˆåŸŸåä¸åŒï¼‰
http://v2.www.example.com/dir/other.htmlï¼šä¸åŒæºï¼ˆåŸŸåä¸åŒï¼‰
http://www.example.com:81/dir/other.htmlï¼šä¸åŒæºï¼ˆç«¯å£ä¸åŒï¼‰
https://www.example.com/dir/page.htmlï¼šä¸åŒæºï¼ˆåè®®ä¸åŒï¼‰
```

### åŒæºæ”¿ç­–çš„ç›®çš„

åŒæºæ”¿ç­–æ˜¯ä¸ºäº†ä¿è¯ç”¨æˆ·ä¿¡æ¯çš„å®‰å…¨ï¼Œé˜²æ­¢æ¶æ„çš„ç½‘ç«™çªƒå–æ•°æ®ã€‚æœ€åˆçš„åŒæºæ”¿ç­–æ˜¯æŒ‡ A ç½‘ç«™åœ¨å®¢æˆ·ç«¯è®¾ç½®çš„ `Cookie`ï¼ŒB ç½‘ç«™æ˜¯ä¸èƒ½è®¿é—®çš„ã€‚

éšç€äº’è”ç½‘çš„å‘å±•ï¼ŒåŒæºæ”¿ç­–ä¹Ÿè¶Šæ¥è¶Šä¸¥æ ¼ï¼Œåœ¨ä¸åŒæºçš„æƒ…å†µä¸‹ï¼Œå…¶ä¸­æœ‰ä¸€é¡¹è§„å®šå°±æ˜¯æ— æ³•å‘éåŒæºåœ°å€å‘é€ `Ajax` è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚ï¼Œæµè§ˆå™¨å°±ä¼šæŠ¥é”™ã€‚

### åŒæºæ”¿ç­–æµ‹è¯•

> æµ‹è¯•éåŒæºAjaxè¯·æ±‚

æœåŠ¡å™¨ **2** çš„  `app.js`   

```js
const express = require('express')
const app = express()

app.get('/test', (req, req) => {
	res.send('ok')
})
app.listen(3001)
```

æœåŠ¡å™¨ **1** ä¸­çš„ `Ajax` è¯·æ±‚

```js
var xhr = new XMLHttpRequest()
xhr.open('get', 'http://localhost:3001/test')
xhr.send()
xhr.onload = function () {
    if (xhr.status === 200) { 
        console.log(xhr.responseText)
    } 
}
```

**å¾—åˆ°ç»“æœ**

![9.png](https://my-blog-leo.oss-cn-chengdu.aliyuncs.com/35.webp)

**å®é™…ä¸Šè¯·æ±‚å·²ç»å‘é€å‡ºå»äº†ï¼Œä½†æ˜¯è¢«æµè§ˆå™¨æ‹’ç»äº†ã€‚**



## `JSONP` è§£å†³åŒæºé™åˆ¶

> `Jsonp`ï¼ˆå°†`json`æ•°æ®å¡«å……åœ¨å‡½æ•°ä¸­è¿”å›ç»™å®¢æˆ·ç«¯ï¼‰æ˜¯ `json with padding` çš„ç¼©å†™ï¼Œ**å®ƒä¸æ˜¯ `Ajax` è¯·æ±‚ï¼Œä½†å®ƒå¯ä»¥æ¨¡æ‹Ÿ `Ajax` è¯·æ±‚ã€‚**

### æ­¥éª¤

é¦–å…ˆå°†ä¸åŒæºçš„è¯·æ±‚åœ°å€å†™åœ¨`script`æ ‡ç­¾çš„`src`å±æ€§ä¸­ã€‚**`script`æ ‡ç­¾çš„`src`å±æ€§æ˜¯ä¸å—åŒæºæ”¿ç­–æ‰€å½±å“çš„ï¼Œå¦‚å¼•å…¥`jQuery`ã€‚**

```html
<script src=â€œhttps://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="www.example.com"></script>
```

::: tip æ³¨æ„

`script` æ ‡ç­¾çš„ `src` å±æ€§çš„è¿æ¥ä¸ä¸€å®šæ˜¯ä»¥ `js` æ–‡ä»¶ç»“å°¾ï¼Œå¯ä»¥æ˜¯ä»»æ„åœ°å€ï¼Œä½†æ˜¯è¿”å›å€¼å¿…é¡»æ˜¯åˆæ³•çš„ `JavaScript` ä»£ç 

:::

**ä¸åŒæºæœåŠ¡ç«¯å“åº”æ•°æ®å¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨ï¼ŒçœŸæ­£è¦å‘é€ç»™å®¢æˆ·ç«¯çš„æ•°æ®éœ€è¦ä½œä¸ºå‡½æ•°è°ƒç”¨çš„å‚æ•°ã€‚**

```js
const data = 'fn({name: "å¼ ä¸‰", age: "20"})'
res.send(data)
```

åœ¨å®¢æˆ·ç«¯å…¨å±€ä½œç”¨åŸŸä¸‹å®šä¹‰å‡½æ•° `fn`

```js
function fn (data) { }
```

åœ¨ `fn` å‡½æ•°å†…éƒ¨å¯¹æœåŠ¡å™¨ç«¯è¿”å›çš„æ•°æ®è¿›è¡Œå¤„ç†

```js
function fn (data) { console.log(data); }
```

**å®Œæ•´ç¤ºä¾‹**

**`app.js`**

```js
const express = require('express')
const app = express()

app.get('/test', (req, res)=>{
    res.send(`fn('ok')`)
})

app.listen(3001)
```

**å®¢æˆ·ç«¯é¡µé¢** ï¼ˆhttp://localhost:3000ï¼‰

```html
<script>
    function fn (data) {
        console.log('å®¢æˆ·ç«¯çš„fnå‡½æ•°è¢«è°ƒç”¨äº†')
        console.log(data);
    }
</script>
<!-- 1.å°†éåŒæºæœåŠ¡å™¨ç«¯çš„è¯·æ±‚åœ°å€å†™åœ¨scriptæ ‡ç­¾çš„srcå±æ€§ä¸­ -->
<script src="http://localhost:3001/test">
	//ä»ä¸åŒæºçš„æœåŠ¡å™¨è¯·æ±‚å›æ¥çš„ä»£ç  fn('ok') æ‰§è¡Œ fn å‡½æ•° ï¼Œ`ok` ä½œä¸ºå½¢å‚ä¼ å…¥
</script> 
```

ç»“æœ

![10.png](https://my-blog-leo.oss-cn-chengdu.aliyuncs.com/36.webp)

###  ğŸ‘‰ ä¼˜åŒ–ä¸€ å‡½æ•°åç§°é—®é¢˜

ç”±äºä¸åŒæºæœåŠ¡ç«¯è¿”å›çš„å‡½æ•°åç§°å¯èƒ½å‰ç«¯å·²ç»ä½¿ç”¨äº†ï¼Œå°±ä¼šé€ æˆå‘½åå†²çªã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¦æ±‚å®¢æˆ·ç«¯è¯·æ±‚æ—¶åŠ ä¸Šå‡½æ•°åç§°ã€‚

**ä¼˜åŒ–åçš„ä»£ç **

**å®¢æˆ·ç«¯**

 ```html
<script>
    function fn2 (data) {
        console.log('å®¢æˆ·ç«¯çš„fnå‡½æ•°è¢«è°ƒç”¨äº†')
        console.log(data);
    }
</script>
<!-- 1.å°†éåŒæºæœåŠ¡å™¨ç«¯çš„è¯·æ±‚åœ°å€å†™åœ¨scriptæ ‡ç­¾çš„srcå±æ€§ä¸­ -->
<script src="http://localhost:3001/better?callback=fn2"></script>
 ```

**ä¸åŒæºæœåŠ¡ç«¯**

```js
app.get('/better', (req, res)=>{
    const funName = req.query.callback
    let data = {
        name: 'å¼ ä¸‰'
    }
    data = JSON.stringify(data)
    const result = `${funName}(${data})` // fn2({name: 'å¼ ä¸‰'})
    res.send(result)
})
```

### ğŸ‘‰ä¼˜åŒ–äºŒ è¯·æ±‚æ‰§è¡Œæ§åˆ¶

ä¹‹å‰çš„è¯·æ±‚éƒ½æ˜¯é¡µé¢ä¸€åŠ è½½å°±æ‰§è¡Œäº†ï¼Œéƒ½ä¸èƒ½æ»¡è¶³æƒ³ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå°±ä»€ä¹ˆæ—¶å€™æ‰§è¡Œçš„éœ€æ±‚ã€‚æ‰€ä»¥ç”¨ **åŠ¨æ€åˆ›å»º `script` æ ‡ç­¾** æ¥è§£å†³é—®é¢˜ã€‚

**å®Œæ•´ç¤ºä¾‹**

æŒ‰é’®ç‚¹å‡»ååŠ¨æ€åˆ›å»º`script`æ ‡ç­¾å¹¶è®¾ç½®å¥½`scr`å±æ€§ï¼Œå†è¿½åŠ åˆ°é¡µé¢ä¸­ï¼Œæ·»åŠ åˆ°é¡µé¢ä¸Šæ—¶ï¼Œç«‹é©¬å‘é€è¯·æ±‚ï¼Œå½“è§¦å‘`script`åŠ è½½å®Œæˆäº‹ä»¶ï¼ˆ`script.onload`ï¼‰åï¼Œå†åˆ é™¤æ·»åŠ çš„`script`æ ‡ç­¾ï¼Œæœ€ç»ˆå®ç°äº†ç‚¹å‡»åå†å‘é€è¯·æ±‚ã€‚

**å®¢æˆ·ç«¯**

```html
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Document</title>
    </head>
    <body>
        <button id="btn">ç‚¹æˆ‘å‘é€è¯·æ±‚</button>
        <script>
            function fn2 (data) {
                console.log('å®¢æˆ·ç«¯çš„fnå‡½æ•°è¢«è°ƒç”¨äº†')
                console.log(data);
            }
        </script>
        <script type="text/javascript">
            let btn = document.getElementById('btn')
            btn.onclick = function() {
                let script = document.createElement('script')
                script.src = 'http://localhost:3001/better?callback=fn2'
                document.body.appendChild(script)
                script.onload = function () {
                    console.log('è¯·æ±‚å®Œæˆåˆ é™¤scriptæ ‡ç­¾')
                    document.body.removeChild(script)
                }
            }
        </script>
    </body>
</html>
```

**ä¸åŒæºæœåŠ¡ç«¯**

```js
app.get('/better', (req, res)=>{
    const funName = req.query.callback
    let data = {
        name: 'å¼ ä¸‰'
    }
    data = JSON.stringify(data)
    const result = `${funName}(${data})`
    res.send(result)
})
```

### ğŸ‘‰ä¼˜åŒ–ä¸‰å°è£…`JSONP`å‡½æ•° (`res.jsonp`)

å¯¹äºä¹‹å‰çš„ä»£ç æ¥è¯´ï¼Œæ¯å®ç°ä¸€æ¬¡è¯·æ±‚å°±è¦å†™ä¸€è¾¹é‡å¤çš„ä»£ç ï¼Œæ‰€ä»¥æŠŠ å°è£…ä¸€ä¸ª `JSONP` å‡½æ•°æ¥ç®€åŒ–ä»£ç 

`jsonp` å‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¯¹è±¡ç»“æ„å¦‚ä¸‹

```js
{
    url: '...', //è¯·æ±‚åœ°å€
    data: { //è¯·æ±‚æ•°æ®
        //...
    },
    success: function () {//è¯·æ±‚æˆåŠŸåæ‰§è¡Œçš„å‡½æ•°ï¼Œåœ¨å‡½æ•°ä¸­è·å–æœåŠ¡å™¨è¿”å›çš„æ•°æ®
        //...
    }    
}
```

**`jsonp`å‡½æ•°å®Œæ•´ç¤ºä¾‹**

```js
function jsonp(options) {
    var script = document.createElement('script')
    //éšæœºå‡½æ•°åï¼Œè¯·æ±‚æˆåŠŸåæ‰§è¡Œçš„å‡½æ•°ï¼Œï¼ˆä»ä¸­è·å–è¿”å›çš„æ•°æ®ï¼‰
    var funName = 'myJSONP' + Math.random().toString().replace('.', '')
    var params = ''
    // è§£æå‚æ•°
    for (var attr in options.data) {
        params += `${attr}=${options.data[attr]}&`
    }
    //æŠŠè¯·æ±‚æˆåŠŸåæ‰§è¡Œçš„å‡½æ•°æš´éœ²åœ¨å…¨å±€ä¸­
    window[funName] = options.success
    //è®¾ç½®scriptçš„srcå±æ€§
    script.src = options.url + '?' + params + `callback=${funName}`
    //æ·»åŠ åˆ°é¡µé¢ä¸­
    document.body.appendChild(script)
    //åŠ è½½å®Œæˆåè§¦å‘
    script.onload = function () {
        console.log('è¯·æ±‚å®Œæˆï¼Œåˆ é™¤scriptæ ‡ç­¾')
        document.body.removeChild(script)
    }
}
```

::: tip å‡½æ•°æ³¨æ„ç‚¹

* éšæœºå‡½æ•°å

```js
//éšæœºå‡½æ•°å
var funName = 'myJSONP' + Math.random().toString().replace('.', '')
```

* å®šä¹‰å…¨å±€å‡½æ•°

```js
//æŠŠè¯·æ±‚æˆåŠŸåæ‰§è¡Œçš„å‡½æ•°æš´éœ²åœ¨å…¨å±€ä¸­
window[funName] = options.success
```

:::

**ä½¿ç”¨**

**å®¢æˆ·ç«¯**

```js
let btn = document.getElementById('btn')
btn.onclick = function () {
    //è°ƒç”¨jsonpå‡½æ•°ï¼Œå¹¶ä¼ å…¥æŒ‡å®šå¯¹è±¡ä½œä¸ºå‚æ•°
    jsonp({
        url: 'http://localhost:3001/better2', //è¯·æ±‚åœ°å€
        data: { //æ•°æ®
            name: 'å¼ ä¸‰',
            age: 12
        },
        success: function (data) { //è¯·æ±‚å®Œæˆæ‰§è¡Œçš„å‡½æ•° ï¼Œè·å–æœåŠ¡å™¨è¿”å›çš„æ•°æ®
            console.log(data)
        }
    })
}
```

**ä¸åŒæºæœåŠ¡ç«¯**

```js

app.get('/better2', (req, res)=>{
    console.log(req.query.name)
    let funName = req.query.callback
    let data = {
        name: req.query.name,
        age: req.query.age,
        stauts: 'ban'
    }
    data = JSON.stringify(data)
    let result = `${funName}(${data})`
    res.send(result)
})

//ä¼˜åŒ–åçš„ä»£ç  ä½¿ç”¨ res.josnpæ–¹æ³•
app.get('/better2', (req, res)=>{
	res.jsonp({
		name: req.query.name,
		age: req.query.age,
		status: 'ban'
	})
})
```

::: tip æ³¨æ„

`express` æ¡†æ¶ä¸­æä¾›äº†`res.jsonp`æ–¹æ³•ï¼Œæ›¿æˆ‘ä»¬å®Œæˆäº†è¦è¿”å›çš„å‡½æ•°è°ƒç”¨ä»£ç å­—ç¬¦ä¸²çš„æ‹¼æ¥ï¼Œåªéœ€è¦ä¼ å…¥è¦è¿”å›çš„æ•°æ®å³å¯ï¼Œå¤§å¤§ç®€åŒ–äº†æ“ä½œã€‚

:::

#### åŸç†æ€»ç»“

1. é¦–å…ˆä½¿ç”¨`script`çš„`src`å±æ€§çš„ä¸å—åŒæºæ”¿ç­–çº¦æŸçš„ç‰¹ç‚¹ï¼Œåˆ›å»º `script` å…ƒç´ å¹¶è®¾ç½® `src` å±æ€§ä¸ºè¯·æ±‚åœ°å€ã€‚
2. ç„¶ååœ¨å®¢æˆ·ç«¯ä¸­å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨æ¥è·å–ä¸åŒæºæœåŠ¡ç«¯è¿”å›çš„æ•°æ®ï¼ˆæ•°æ®ä»å‡½æ•°çš„å½¢å‚ä¸­è¿”å›ï¼‰ã€‚
3. æŠŠ `script` å…ƒç´ è¿½åŠ åˆ°é¡µé¢ä¸­ï¼Œç„¶å`script`æ ‡ç­¾å°±å‘æŒ‡å®šåœ°å€å‘é€è¯·æ±‚ã€‚æ³¨æ„ï¼**å‘é€çš„è¯·æ±‚ä¸­ä¸ä»…åŒ…å«è¦ä¼ é€’çš„æ•°æ®ï¼Œè¿˜è¦æŠŠè·ç”¨æ¥å–æ•°æ®çš„å‡½æ•°çš„åå­—ä¸€èµ·æäº¤åˆ°æœåŠ¡å™¨ç«¯ã€‚**
4. ä¸åŒæºæœåŠ¡ç«¯æ¥æ”¶åˆ°å‰ç«¯çš„è¯·æ±‚ï¼Œè·å–è¯·æ±‚å‚æ•°ã€‚å¾—åˆ°ä¼ æ¥çš„å‡½æ•°ï¼ˆ`fun`ï¼‰åå­—ï¼Œ**å¹¶å°†è¦è¿”å›çš„æ•°æ®ä»¥ `json` çš„æ ¼å¼** æ‹¼æ¥åˆ°å‡½æ•°   `fun` è°ƒç”¨çš„ä»£ç å­—ç¬¦ä¸²ä¸­ã€‚å¦‚ï¼š`'fun({â€œnameâ€: "å¼ ä¸‰", â€œageâ€: "20"})'` è¿™æ ·çš„å‡½æ•°è°ƒç”¨ä»£ç çš„å­—ç¬¦ä¸²ã€‚
5. å®¢æˆ·ç«¯ç»™æ”¶åˆ°ä¸åŒæºæœåŠ¡ç«¯è¿”å›çš„å‡½æ•°æ‰§è¡Œçš„ä»£ç ã€‚ç«‹å³æ‰§è¡Œè¿™å¥ä»£ç æ‰§è¡Œå‡½æ•°ï¼Œç”±äºè¯¥å‡½æ•°ä¹‹å‰å·²ç»å®šä¹‰å¥½äº†ï¼Œæ‰€ä»¥æ­£å¸¸æ‰§è¡Œå°± `ok` äº†ã€‚

**ç”±æ­¤å¯çŸ¥ï¼šå®¢æˆ·ç«¯å®šä¹‰çš„å‡½æ•°å¯ä»¥ä»å½¢å‚ä¸­å¾—åˆ°æ•°æ®çš„åŸå› æ˜¯ï¼Œä¸åŒæºæœåŠ¡ç«¯è¿”å›äº†ä¸€ä¸ªï¼ˆä¼ å…¥äº†ä¸€ä¸ªæ•°æ®ä½œä¸ºå½¢å‚çš„åŒåå‡½æ•°çš„è°ƒç”¨çš„`js`ä»£ç ï¼‰ã€‚å¦‚ï¼š`'fun({name: "å¼ ä¸‰", age: "20"})'` è¿™æ ·çš„å‡½æ•°è°ƒç”¨ä»£ç çš„å­—ç¬¦ä¸²ã€‚**



## `CORS` è·¨åŸŸå…±äº«è§£å†³åŒæºæ”¿ç­–

### æ¦‚è¿°

`CORS`ï¼šå…¨ç§°ä¸º `Cross-origin resource sharing`ï¼Œå³è·¨åŸŸèµ„æºå…±äº«ï¼Œå®ƒå…è®¸æµè§ˆå™¨å‘è·¨åŸŸæœåŠ¡å™¨å‘é€ `Ajax` è¯·æ±‚ï¼Œå…‹æœäº† `Ajax` åªèƒ½åŒæºä½¿ç”¨çš„é™åˆ¶ã€‚

![11.png](https://my-blog-leo.oss-cn-chengdu.aliyuncs.com/37.webp)

åœ¨è·¨åŸŸè¯·æ±‚æ—¶ï¼Œè¯·æ±‚å¤´ä¸­æœ‰ `origin` å­—æ®µä¿å­˜äº†å‘èµ·è¯·æ±‚çš„ç½‘ç«™çš„åŸŸåä¿¡æ¯ã€‚å¦‚`origin: http://localhost:3000`ã€‚æœåŠ¡å™¨ä¼šæ ¹æ®æ­¤å­—æ®µï¼Œåˆ¤è¯»æ˜¯å¦åŒæ„æ­¤æ¬¡è¯·æ±‚ã€‚æ— è®ºæœåŠ¡å™¨æ˜¯å¦åŒæ„æ­¤æ¬¡è¯·æ±‚ï¼Œéƒ½ä¼šç»™å®¢æˆ·ç«¯ä¸€ä¸ªæ­£å¸¸çš„å“åº”ã€‚å¦‚æœæœåŠ¡å™¨åŒæ„æ­¤æ¬¡è¯·æ±‚åˆ™åœ¨å“åº”å¤´ä¸­æ·»åŠ   `Access-Control-Allow-Origin` å­—æ®µï¼ˆ`Access-Control-Allow-Origin: 'http://localhost:3000'`æˆ–è€…æ˜¯  `Access-Control-Allow-Origin: '*'`ï¼‰ï¼Œå¦‚æœæ‹’ç»é‚£ä¹ˆå“åº”å¤´ä¸­å°±æ²¡æœ‰è¯¥å­—æ®µã€‚

`Access-Control-Allow-Origin` å¯ä»¥ç†è§£ä¸ºå…è®¸è·¨åŸŸè®¿é—®çš„ç™½åå•ã€‚

`Access-Control-Allow-Origin: 'http://localhost:3000'` å…è®¸è¯¥åŸŸåçš„è¯·æ±‚ã€‚
` Access-Control-Allow-Origin: '*'` å…è®¸æ‰€æœ‰çš„å®¢æˆ·ç«¯è¯·æ±‚ã€‚

### ç¤ºä¾‹

**å®¢æˆ·ç«¯**

```html
<body>
    <button id="btn">ç‚¹æˆ‘å‘é€è¯·æ±‚</button>
    <script src="/js/ajax.js"></script>
    <script>
        // è·å–æŒ‰é’®
        var btn = document.getElementById('btn');
        // ä¸ºæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        btn.onclick = function () {
            ajax({
                type: 'get',
                url: 'http://localhost:3001/cross',
                success: function (data) {
                    console.log(data)
                }
            })
        };
    /script>
</body>
```

**æœåŠ¡ç«¯**

éœ€è¦åœ¨å“åº”å¤´ä¸­è®¾ç½®ï¼š

1. å…è®¸å“ªäº›å®¢æˆ·ç«¯è®¿é—®æœåŠ¡å™¨ç«¯ã€‚`'Access-Control-Allow-Origin', '*'`
2. å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡å“ªäº›è¯·æ±‚æ–¹æ³•æ¥è®¿é—®æœåŠ¡å™¨ç«¯ (`GET or POST` ã€ `only GET` ã€ `only POST`) ã€‚`'Access-Control-Allow-Methods', 'get, post' `

```js
app.get('/cross', (req, res) => {
    //å…è®¸å“ªäº›å®¢æˆ·ç«¯è®¿é—®
    //* ä»£è¡¨æ‰€æœ‰çš„ç”¨æˆ·
    res.header('Access-Control-Allow-Origin', '*')
    //å…è®¸å®¢æˆ·ç«¯ä½¿ç”¨å“ªäº›è¯·æ±‚æ–¹æ³•è®¿é—® get æˆ–è¿™ post çš†å¯
    res.header('Access-Control-Allow-Methods', 'get, post')
    res.send('æ•°æ®')
})

//ä¼˜åŒ–ï¼Œå¯¹æ‰€æœ‰çš„è¯·æ±‚è®¾ç½®å“åº”å¤´ã€‚
app.use((req, res, next) => {
    res.header('Access-Control-Allow-Origin', '*');
    res.header('Access-Control-Allow-Methods', 'GET, POST');
    next();
})
```

**ç»“æœ** è¯·æ±‚æˆåŠŸ



## è®¿é—®éåŒæºæ•°æ®æœåŠ¡å™¨ç«¯è§£å†³æ–¹æ¡ˆ ï¼ˆç¬¬ä¸‰æ–¹æ¨¡å—`requst`ï¼‰

### æ¦‚è¿°

åŒæºæ”¿ç­–æ˜¯æµè§ˆå™¨ç»™äºˆ `Ajax` æŠ€æœ¯çš„é™åˆ¶ï¼ŒæœåŠ¡å™¨ç«¯æ˜¯ä¸å­˜åœ¨åŒæºæ”¿ç­–é™åˆ¶ã€‚ç”±äºå®¢æˆ·ç«¯ä¸èƒ½ç›´æ¥é€šè¿‡ `Ajax` è·¨åŸŸè¯·æ±‚å¾—åˆ°æ•°æ®ï¼Œåˆå› ä¸ºå®¢æˆ·ç«¯ä¸å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼Œæ‰€ä»¥é€šè¿‡æœåŠ¡ç«¯è§£å†³æ­¤é—®é¢˜ã€‚

è§£å†³æ–¹æ¡ˆå›¾

![12.png](https://my-blog-leo.oss-cn-chengdu.aliyuncs.com/38.png)

è¯·æ±‚æµç¨‹ï¼š

`A` æµè§ˆå™¨è¯·æ±‚ `A` æœåŠ¡å™¨ï¼Œ`A` æœåŠ¡å™¨åœ¨è¯·æ±‚ `B` æœåŠ¡å™¨ï¼Œ`A` æœåŠ¡å™¨ä» `B` æœåŠ¡å™¨å¾—åˆ°å“åº”åï¼Œå†å“åº”å› `A` æµè§ˆå™¨ã€‚

### ä½¿ç”¨ç¬¬ä¸‰æ–¹æ¨¡å— `requst` 

è¯¥æ¨¡å—æ˜¯å‘å…¶ä»–æœåŠ¡å™¨ç«¯è¯·æ±‚æ•°æ®çš„æ¨¡å—

å¼•å…¥

```js
const requst = require('requst')
```

`request` å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°

å‚æ•°ä¸€ï¼šéœ€è¦è¯·æ±‚çš„åœ°å€ã€‚

å‚æ•°äºŒï¼šè¯·æ±‚å›è°ƒå‡½æ•°ã€‚å›è°ƒå‡½æ•°ä¸­æœ‰ä¸‰ä¸ªå½¢å‚åˆ†åˆ«æ˜¯ `error` é”™è¯¯å¯¹è±¡ã€ `response` å“åº”å¯¹è±¡ ã€ `body ` å“åº”çš„å†…å®¹

**å®Œæ•´ç¤ºä¾‹**

**å®¢æˆ·ç«¯**

```js
// è·å–æŒ‰é’®
var btn = document.getElementById('btn');
// ä¸ºæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
btn.onclick = function () {
    ajax({
        type: 'get',
        url: 'http://localhost:3000/server',
        success: function (data) {
            console.log(data);
        }
    })
};
```

**æœåŠ¡å™¨ä¸€** (http://localhost:3000)

```js
// å‘å…¶ä»–æœåŠ¡å™¨ç«¯è¯·æ±‚æ•°æ®çš„æ¨¡å— request
const request = require('request');

app.get('/server', (req, res) => {
    request('http://localhost:3001/cross', (err, response, body) => {
        res.send(body)
    })
})

```

**æœåŠ¡å™¨äºŒ** (http://localhost:3001)

```js
app.get('/cross', (req, res) => {
    res.send('æ•°æ®')
})
```



## `withCredentials`å±æ€§

### æ¦‚è¿°

åœ¨ä¸è·¨åŸŸçš„æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯è¯·æ±‚ä¼šè‡ªåŠ¨æŠŠ `cookie` å‘é€åˆ°æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨ä»è€Œè·å–å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œä½†æ˜¯åœ¨è·¨åŸŸçš„æƒ…å†µä¸‹ï¼ˆå‡ºäºå®‰å…¨æ€§çš„è€ƒè™‘ï¼‰æ˜¯ä¸ä¼šæºå¸¦ `cookie` ä¿¡æ¯çš„ã€‚**åœ¨ä½¿ç”¨ `Ajax` æ—¶å€™é»˜è®¤ä¸ä¼šåœ¨è¯·æ±‚ä¸­æºå¸¦ `cookie` ä¿¡æ¯ã€‚**

è¦æ»¡è¶³ `Ajax` è·¨åŸŸè¯·æ±‚æºå¸¦ `cookie` çš„éœ€æ±‚ï¼šåœ¨ `Ajax` å¯¹è±¡ä¸­æœ‰ä¸€ä¸ªå±æ€§`withCredentials`å¯ä»¥æŒ‡å®šåœ¨æ¶‰åŠåˆ°è·¨åŸŸè¯·æ±‚æ—¶ï¼Œæ˜¯å¦æºå¸¦ `cookie` ä¿¡æ¯ï¼Œé»˜è®¤å€¼ä¸º `false`ã€‚åªè®¾ç½®è¿™ä¸ªå±æ€§æ˜¯ä¸è¡Œçš„ï¼Œè¿˜è¦åœ¨æœåŠ¡ç«¯çš„å“åº”å¤´ä¸­æ·»åŠ `Access-Control-Allow-Credentials`å±æ€§ã€‚å¦‚æœè®¾ç½®ä¸º `true` å…è®¸å®¢æˆ·ç«¯å‘é€è¯·æ±‚æ—¶æºå¸¦ `cookie`ã€‚

### æ¡ˆä¾‹è·¨åŸŸç™»å½•

**å®¢æˆ·ç«¯**

```html
<div class="container">
    <form id="loginForm">
        <div class="form-group">
            <label>ç”¨æˆ·å</label>
            <input type="text" name="username" class="form-control" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
        </div>
        <div class="form-group">
            <label>å¯†ç </label>
            <input type="password" name="password" class="form-control" placeholder="è¯·è¾“å…¥ç”¨å¯†ç ">
        </div>
        <input type="button" class="btn btn-default" value="ç™»å½•" id="loginBtn">
        <input type="button" class="btn btn-default" value="æ£€æµ‹ç”¨æˆ·ç™»å½•çŠ¶æ€" id="checkLogin">
    </form>
</div>
```

```js
var loginBtn = document.getElementById('loginBtn')
var checkLogin = document.getElementById('checkLogin')
var form = document.getElementById('loginForm')

loginBtn.onclick = function () {
    var formData = new FormData(form)
    var xhr = new XMLHttpRequest()
    xhr.open('post', 'http://localhost:3001/login')
    //å½“å‘é€è·¨åŸŸè¯·æ±‚æ—¶æºå¸¦cookieä¿¡æ¯
    xhr.withCredentials = true
    xhr.send(formData)
    xhr.onload = function () {
        console.log(xhr.responseText)
    }
}

checkLogin.onclick = function () {
    var xhr = new XMLHttpRequest()
    xhr.open('get', 'http://localhost:3001/checkLogin')
    //å½“å‘é€è·¨åŸŸè¯·æ±‚æ—¶æºå¸¦cookieä¿¡æ¯
    xhr.withCredentials = true
    xhr.send()
    xhr.onload = function () {
        console.log(xhr.responseText)
    }
}
```

**è·¨åŸŸæœåŠ¡ç«¯**

```js
// å¼•å…¥expressæ¡†æ¶
const express = require('express');
var session = require('express-session');
// åˆ›å»ºwebæœåŠ¡å™¨
const app = express();
// å®ç°sessionåŠŸèƒ½
app.use(session({
  secret: 'keyboard cat',
  resave: false,
  saveUninitialized: false
}));

app.use((req, res, next) => {
    // 1.å…è®¸å“ªäº›å®¢æˆ·ç«¯è®¿é—®æˆ‘
    // * ä»£è¡¨å…è®¸æ‰€æœ‰çš„å®¢æˆ·ç«¯è®¿é—®æˆ‘
    // æ³¨æ„ï¼šå¦‚æœè·¨åŸŸè¯·æ±‚ä¸­æ¶‰åŠåˆ°cookieä¿¡æ¯ä¼ é€’ï¼Œå€¼ä¸å¯ä»¥ä¸º*å· è¦å¡«çš„å€¼ï¼Œæ¯”å¦‚æ˜¯å…·ä½“çš„åŸŸåä¿¡æ¯
    res.header('Access-Control-Allow-Origin', 'http://localhost:3000')
    // 2.å…è®¸å®¢æˆ·ç«¯ä½¿ç”¨å“ªäº›è¯·æ±‚æ–¹æ³•è®¿é—®æˆ‘
    res.header('Access-Control-Allow-Methods', 'get,post')
    // å…è®¸å®¢æˆ·ç«¯å‘é€è·¨åŸŸè¯·æ±‚æ—¶æºå¸¦cookieä¿¡æ¯
    res.header('Access-Control-Allow-Credentials', true);
    next();
})


app.post('/login', (req, res) => {
	// åˆ›å»ºè¡¨å•è§£æå¯¹è±¡
	var form = formidable.IncomingForm();
	// è§£æè¡¨å•
	form.parse(req, (err, fields, file) => {
		// æ¥æ”¶å®¢æˆ·ç«¯ä¼ é€’è¿‡æ¥çš„ç”¨æˆ·åå’Œå¯†ç 
		const { username, password } = fields;
		// ç”¨æˆ·åå¯†ç æ¯”å¯¹
		if (username == 'itheima' && password == '123456') {
			// è®¾ç½®session
			req.session.isLogin = true;
			res.send({message: 'ç™»å½•æˆåŠŸ'});
		} else {
			res.send({message: 'ç™»å½•å¤±è´¥, ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'});
		}
	})
});

app.get('/checkLogin', (req, res) => {
	// åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¤„äºç™»å½•çŠ¶æ€
	if (req.session.isLogin) {
		res.send({message: 'å¤„äºç™»å½•çŠ¶æ€'})
	} else {
		res.send({message: 'å¤„äºæœªç™»å½•çŠ¶æ€'})
	}
});
```

## 

## `jQuery` ä¸­çš„ `$.Ajax` æ–¹æ³•

### æ¦‚è¿°

å®ƒçš„ä½œç”¨æ˜¯å‘é€ `Ajax` è¯·æ±‚ã€‚

### ä½¿ç”¨

`$.ajax` æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¯¹è±¡ç»“æ„å¦‚ä¸‹ï¼š

```js
{	 //è¯·æ±‚æ–¹å¼
     type: 'get',
     //è¯·æ±‚åœ°å€
     url: 'http://www.example.com',
     data: { name: 'zhangsan', age: '20' }, 
     
     contentType: 'application/x-www-form-urlencoded',
     beforeSend: function () { 
         return false
     },
     success: function (response) {},
     error: function (xhr) {}
}
```

`type`ï¼šè¯·æ±‚æ–¹å¼

`url`ï¼šè¯·æ±‚åœ°å€

`data`ï¼šè¯·æ±‚å‚æ•°ã€‚è¯·æ±‚å‚æ•° å¯ä»¥å‚æ•°ä¼ é€’å­—ç¬¦ä¸²`(name=cyx&age=22)`ã€‚ä¼ é€’å¯¹è±¡çš„è¯ï¼Œä¼šè‡ªåŠ¨è¢«æ‹¼æ¥æˆå‚æ•°å­—ç¬¦ä¸²ã€‚`(name=cyx&age=220)`ã€‚è¿˜å¯ä»¥ä¼ é€’ `json` å­—ç¬¦ä¸²ï¼Œä½†æ˜¯åŒæ—¶è¦è®¾ç½®å‚æ•°ç±»å‹ `Content-Type` ã€‚

`contentType`ï¼šè®¾ç½®è¯·æ±‚å‚æ•°çš„æ ¼å¼ã€‚é»˜è®¤å€¼ä¸º `application/x-www-form-urlencoded`ã€‚`json` æ ¼å¼ï¼š`application/json`

`beforeSend`ï¼šè¯·æ±‚æ‰§è¡Œä¹‹å‰åšä¸€äº›äº‹æƒ…ã€‚å¦‚ï¼šå¯ä»¥å¯¹è¯·æ±‚å‚æ•°çš„å€¼è¿›è¡Œæ ¼å¼éªŒè¯ï¼Œå¦‚æœä¸æ»¡è¶³è¦æ±‚ `return false` ç»“æŸæ­¤æ¬¡è¯·æ±‚ã€‚è¿˜å¯ä»¥æ˜¾ç¤ºè¯·æ±‚ç­‰å¾…å›¾ç‰‡ã€‚

`success`ï¼šè¯·æ±‚æˆåŠŸåï¼ŒæœåŠ¡ç«¯è¿”å›æ•°æ®ï¼Œè°ƒç”¨æ­¤å‡½æ•°ã€‚å½¢å‚å°±æ˜¯è¿”å›çš„æ•°æ®ã€‚

`error`ï¼šè¯·æ±‚å¤±è´¥æ—¶æ‰§è¡Œå‡½æ•°ï¼Œå½¢å‚ `xhr` å¯¹è±¡ã€‚

### æ¡ˆä¾‹

#### åŸºæœ¬ä½¿ç”¨

**é¡µé¢**

```js
<button id="btn">å‘é€è¯·æ±‚</button>
<script src="/js/jquery.min.js"></script>
<script>
    $('#btn').on('click', function () {
    $.ajax({
        // è¯·æ±‚æ–¹å¼
        type: 'get',
        // è¯·æ±‚åœ°å€
        url: '/base',
        // è¯·æ±‚æˆåŠŸä»¥åå‡½æ•°è¢«è°ƒç”¨
        success: function (response) {
            // responseä¸ºæœåŠ¡å™¨ç«¯è¿”å›çš„æ•°æ®
            // æ–¹æ³•å†…éƒ¨ä¼šè‡ªåŠ¨å°†jsonå­—ç¬¦ä¸²è½¬æ¢ä¸ºjsonå¯¹è±¡
            console.log(response);
        },
        // è¯·æ±‚å¤±è´¥ä»¥åå‡½æ•°è¢«è°ƒç”¨
        error: function (xhr) {
            console.log(xhr)
        }
    })
});
</script>
```

**`app.js`**

```js
app.get('/base', (req, res) => {
    res.send({
        name: 'zhangsan',
        age: 30
    })
})
```

#### å‘é€è¯·æ±‚å‚æ•°

`get` **å‚æ•°**

```js
$('#btn').on('click', function () {
    $.ajax({
        // è¯·æ±‚æ–¹å¼
        type: 'get',
        // è¯·æ±‚åœ°å€
        url: '/user',
        // å‘æœåŠ¡å™¨ç«¯å‘é€çš„è¯·æ±‚å‚æ•°
        //data:{ name: zhangsam ,age:12}
        data: 'name=zhangsan&age=100',
        // æŒ‡å®šå‚æ•°çš„æ ¼å¼ç±»å‹
        contentType: 'application/json',
        // è¯·æ±‚æˆåŠŸä»¥åå‡½æ•°è¢«è°ƒç”¨
        success: function (response) {
            // responseä¸ºæœåŠ¡å™¨ç«¯è¿”å›çš„æ•°æ®
            // æ–¹æ³•å†…éƒ¨ä¼šè‡ªåŠ¨å°†jsonå­—ç¬¦ä¸²è½¬æ¢ä¸ºjsonå¯¹è±¡
            console.log(response);
        }
    })
});
```

`post`**ä¸€èˆ¬å‚æ•°**

```js
$('#btn').on('click', function () {
    $.ajax({
        // è¯·æ±‚æ–¹å¼
        type: 'post',
        // è¯·æ±‚åœ°å€
        url: '/user',
        // å‘æœåŠ¡å™¨ç«¯å‘é€çš„è¯·æ±‚å‚æ•°
        data: {
            name: 'zhangsan',
            age: 100
        },
        // è¯·æ±‚æˆåŠŸä»¥åå‡½æ•°è¢«è°ƒç”¨
        success: function (response) {
            // responseä¸ºæœåŠ¡å™¨ç«¯è¿”å›çš„æ•°æ®
            // æ–¹æ³•å†…éƒ¨ä¼šè‡ªåŠ¨å°†jsonå­—ç¬¦ä¸²è½¬æ¢ä¸ºjsonå¯¹è±¡
            console.log(response);
        }
    })
});
```

`post`**`json`æ ¼å¼å‚æ•°**

```js
var params = {name: 'wangwu', age: 300}
$('#btn').on('click', function () {
    $.ajax({
        // è¯·æ±‚æ–¹å¼
        type: 'post',
        // è¯·æ±‚åœ°å€
        url: '/user',
        // å‘æœåŠ¡å™¨ç«¯å‘é€çš„è¯·æ±‚å‚æ•°
        data: JSON.stringify(params),
        // æŒ‡å®šå‚æ•°çš„æ ¼å¼ç±»å‹
        contentType: 'application/json',
        // è¯·æ±‚æˆåŠŸä»¥åå‡½æ•°è¢«è°ƒç”¨
        success: function (response) {
            // responseä¸ºæœåŠ¡å™¨ç«¯è¿”å›çš„æ•°æ®
            // æ–¹æ³•å†…éƒ¨ä¼šè‡ªåŠ¨å°†jsonå­—ç¬¦ä¸²è½¬æ¢ä¸ºjsonå¯¹è±¡
            console.log(response);
        }
    })
});
```



### `$.ajax` æ–¹æ³•å‘é€ `jsonp` è¯·æ±‚

åœ¨è°ƒç”¨ `$.ajax` æ–¹æ³•æ—¶ï¼Œä¼ å…¥ä¸€ä¸ªå‚æ•° `dataType: â€˜jsonpâ€™` å°±ä»£è¡¨è¦å‘é€ `jsonp` è¯·æ±‚ï¼ˆè·¨åŸŸè¯·æ±‚ï¼‰ã€‚è‹¥ä¸ä¼ å…¥è¿™ä¸ªå‚æ•°åˆ™é»˜è®¤æ˜¯åŒæºçš„ `Ajax`è¯·æ±‚

**ä½¿ç”¨**

```js
$('#btn').on('click', function () {
    $.ajax({
        url: '/jsonp',
        // ä»£è¡¨ç°åœ¨è¦å‘é€çš„æ˜¯jsonpè¯·æ±‚
        dataType: 'jsonp',
        success: function (response) {
            console.log(response)
        }
    })
})
```

**æ›´å¤šå±æ€§**

`jsonp`ã€`jsonCallback` æ˜¯è¿ä¸ªå¯é€‰å‚æ•°ã€‚`jsonp` å±æ€§ä¿®æ”¹ `callback` å‚æ•°åç§°ã€‚`jsonCallback` æŒ‡å®šå‡½æ•°åç§°

```js
//è¯·æ±‚æˆåŠŸåæ‰§è¡Œçš„å‡½æ•°
function fn (response) {
    console.log(response)
}

$('#btn').on('click', function () {
    $.ajax({
        url: '/jsonp',
        // å‘æœåŠ¡å™¨ç«¯ä¼ é€’å‡½æ•°åå­—çš„å‚æ•°åç§° (?cb=funName)
        jsonp: 'cb',
        //è®¾ç½®è¯·æ±‚ç»“æŸåæ‰§è¡Œçš„å‡½æ•°
        jsonpCallback: 'fn',
        // ä»£è¡¨ç°åœ¨è¦å‘é€çš„æ˜¯jsonpè¯·æ±‚
        dataType: 'jsonp'
    })
})
```

`app.js`

```js
app.get('/jsonp', (req, res) => {
    const cb = req.query.cb
    const data = cb+"({name: 'zhaoliu'})"
    res.send(data)
})
```



## `jQuery` ä¸­`serialize` æ–¹æ³•

ä½œç”¨ï¼šå°†è¡¨å•ä¸­çš„æ•°æ®è‡ªåŠ¨æ‹¼æ¥æˆå­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°

```js
var params = $('#form').serialize();
// name=zhangsan&age=30
```

è¿™æ ·ä»»ç„¶ä¸æ–¹ä¾¿ï¼Œå¾—åˆ°è¡¨å•çš„æ•°æ®åï¼Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬å¸Œæœ›æ˜¯ä¸€ä¸ªå¯¹è±¡æ›´ä¾¿äºæ“ä½œã€‚ä¸‹é¢æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªå‡½æ•° `serializeObject` æ¥è¿”å›ä¸€ä¸ªåŒ…å«è¡¨å•æ•°æ®çš„å¯¹è±¡ã€‚

```js
// å°†è¡¨å•ä¸­ç”¨æˆ·è¾“å…¥çš„å†…å®¹è½¬æ¢ä¸ºå¯¹è±¡ç±»å‹
function serializeObject(obj) {
    // å¤„ç†ç»“æœå¯¹è±¡
    var result = {};
    // [{name: 'username', value: 'ç”¨æˆ·è¾“å…¥çš„å†…å®¹'}, {name: 'password', value: '123456'}]
    var params = obj.serializeArray();

    // å¾ªç¯æ•°ç»„ å°†æ•°ç»„è½¬æ¢ä¸ºå¯¹è±¡ç±»å‹
    $.each(params, function (index, value) {
        result[value.name] = value.value;
    })
    // å°†å¤„ç†çš„ç»“æœè¿”å›åˆ°å‡½æ•°å¤–éƒ¨
    return result;
}

//ä½¿ç”¨
$('#form').on('submit', function () {
    // å°†è¡¨å•å†…å®¹æ‹¼æ¥æˆå­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°
    console.log(serializeObject($(this)))
    return false;
});
```

::: tip æ³¨æ„

`serializeArray()` æ–¹æ³•æ˜¯ `jQuery` æä¾›çš„ä¸€ä¸ªå‡½æ•°ï¼Œå±äº `jQuery` è¡¨å•å…ƒç´ ä¸‹çš„æ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨æ˜¯è·å–è¡¨å•çš„æ§ä»¶çš„å€¼ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```js
[
    {
        name: 'username',
        value: 'æ˜Œå®‡çº'
    },
    {
        name: 'password',
        value: '123456'
    },
    ...
]
    
//ä½¿ç”¨
var params = $('#form').serializeArray();
```

:::



## `$.post `\ `$.get`

è¿™ä¸¤ä¸ªæ–¹æ³•çš„ä½¿ç”¨æ–¹å¼æ˜¯ä¸€æ ·çš„ï¼Œæ¥æ”¶ä¸‰ä¸ªå‚æ•°ã€‚

å‚æ•°ä¸€ï¼šè¯·æ±‚åœ°å€

å‚æ•°äºŒï¼šè¯·æ±‚å‚æ•°

å‚æ•°ä¸‰ï¼šå›è°ƒå‡½æ•°

**ä½¿ç”¨**

```js
$.get('http://www.example.com', {name: 'zhangsan', age: 30}, function (response) {}) $.post('http://www.example.com', {name: 'lisi', age: 22}, function (response) {})
```

```js
$.get('/base', 'name=zhangsan&age=31', function (response) {
    console.log(response)
})

$.post('/base', function (response) {
    console.log(response)
})
```

## 

## `jQuery` ä¸­ `Ajax` å…¨å±€äº‹ä»¶

åªè¦æœ‰ `Ajax` è¯·æ±‚å‘é€ï¼Œå¯¹åº”çš„å…¨å±€äº‹ä»¶å°±ä¼šè§¦å‘ã€‚

`ajaxStart()` è¯·æ±‚å¼€å§‹å‘é€æ—¶è§¦å‘ã€‚

`ajaxComplete()` è¯·æ±‚å®Œæˆæ—¶è§¦å‘ã€‚

è¿™ä¸¤ä¸ªå…¨å±€äº‹ä»¶ä¸€å®šè¦ç»‘å®šåœ¨ `document` ä¸Šã€‚

**ç¤ºä¾‹  å‘é€è¯·æ±‚æ—¶æ˜¾ç¤ºè¿›åº¦æ¡**

```js
//å¼•å…¥css å’Œ js æ–‡ä»¶
<link rel="stylesheet" href="/js/nprogress/nprogress.css">
<script src="/js/nprogress/nprogress.js"></script>

//é¡µé¢ä¸­æœ‰ajaxè¯·æ±‚æ—¶è§¦å‘
$(document).on('ajaxStart', function () {
    NProgress.start()
})
//é¡µé¢ä¸­ajaxè¯·æ±‚å®Œæˆæ—¶è§¦å‘
$(document).on('ajaxComplete', function () {
    NProgress.done()
})
```


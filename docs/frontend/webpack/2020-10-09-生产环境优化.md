---
title: "webpack 生产环境优化"
date: 2020-10-09
sidebar: 'auto'
categories:
- FrontEnd
tags:
- webpack
---



# 生产环境优化



## 优化打包速度

### oneOf

当 `webpack` 所配置的 `loader` 处理文件时，会依次的过一遍所有的 `loader`，即使找到了所匹配的 `loader` 也不停止，任然继续向后匹配直至结束。因此使用 `oneOf` 包裹 `loader` 。当匹配到一个对应的 `loader` 后就停止向后匹配，加快了打包后加速度。**注意 ：不能有两个 `loader` 处理同一种文件 。如果出现两个，就从 `oneOf` 中提出去一个**

配置示例

```js
// webpack.config.js 中的 module 配置

module: {
  rules: [
    {
      // 以下loader只会匹配一个
      // 注意：不能有两个配置处理同一种类型文件
      oneOf: [
        {
          test: /\.css$/,
          use: [...commonCssLoader]
        },
        {
          test: /\.less$/,
          use: [...commonCssLoader, 'less-loader']
        },
        // js babel-loader 处理
        // ...
        // ..... 其他配置....
      ]
    },
    { // 由于 oneOf 中有处理 js 的 loader ，于是提出来。
      test: /\.js$/,
      exclude: /node_modules/,
      // 优先执行
      enforce: 'pre',
      loader: 'eslint-loader',
      options: {
        fix: true
      }
    },
  ]
}
```



### 缓存处理

#### babel 缓存

为 `babel-loader` 配置 `cacheDirectory : true` 开启 `babel` 缓存，将兼容性处理代码保存起来，下一次使用的时候直接从缓存读取，加快语法转换速度。

```js
// babel-loader 的配置
{
  	test: /\.js$/,
    exclude: /node_modules/,
    loader: 'babel-loader',
    options: {
      presets: [
        [
          '@babel/preset-env',
          {
            useBuiltIns: 'usage',
            corejs: { version: 3 },
            targets: {
              chrome: '60',
              firefox: '50'
            }
          }
        ]
      ],
        // 开启babel缓存
        // 第二次构建时，会读取之前的缓存
      cacheDirectory: true
   }
}
```



#### 文件资源缓存

每一次加载都页面所有资源都会从新加载，为减小服务器开销、加快客户端的加载速度就必须对文件进行缓存。当服务器文件发生改变时客户端就会从服务器加载资源。那么如何标识问价改变呢？使用文章名称的改变来标识文件的改变。通过在文件名中加入一段 `hash` 值来实实现，一共有三种 `hash` 值

**hash** ：每次 `wepack` 构建时会生成一个唯一的 `hash` 值，将此 hash 值添加在输出文件的文件名中。问题：当一个文件修改，重新打包构建项目产生新的 `hash` 值，但是所有文件的 文件名都变了，于是所有文件都需要重新加载，缓存做的不完美。

**chunkhash** ：根据 `chunk` 生成的 `hash` 值。如果打包来源于同一个 `chunk`，那么 `hash` 值就一样。问题：`js` 和 `css` 的 `hash` 值还是一样的。因为css是在js中被引入的，所以同属于一个chunk（一个入口文件下的所有引用文件打包后的集合）

**contenthash**

```js
const { resolve } = require('path');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');
const OptimizeCssAssetsWebpackPlugin = require('optimize-css-assets-webpack-plugin');
const HtmlWebpackPlugin = require('html-webpack-plugin');

/*

 2 文件资源缓存
    缓存后 优先读取本地缓存 服务器修改后 客户端不变，所以通过改变文件名称来使客户端改变
    hash: 每次wepack构建时会生成一个唯一的hash值。
      问题: 因为js和css同时使用一个hash值。
        如果重新打包，会导致所有缓存失效。（可能我却只改动一个文件）
    chunkhash：根据chunk生成的hash值。如果打包来源于同一个chunk，那么hash值就一样
      问题: js和css的hash值还是一样的
        因为css是在js中被引入的，所以同属于一个chunk（一个入口文件下的所有引用文件打包后的集合）
    contenthash: 根据文件的内容生成hash值。不同文件hash值一定不一样    
    --> 让代码上线运行缓存更好使用
*/

// 定义nodejs环境变量：决定使用browserslist的哪个环境
process.env.NODE_ENV = 'production';

// 复用loader
const commonCssLoader = [
  MiniCssExtractPlugin.loader,
  'css-loader',
  {
    // 还需要在package.json中定义browserslist
    loader: 'postcss-loader',
    options: {
      ident: 'postcss',
      plugins: () => [require('postcss-preset-env')()]
    }
  }
];

module.exports = {
  entry: './src/js/index.js',
  output: {
    filename: 'js/built.[contenthash:10].js',
    path: resolve(__dirname, 'build')
  },
  module: {
    rules: [
      {
        // 在package.json中eslintConfig --> airbnb
        test: /\.js$/,
        exclude: /node_modules/,
        // 优先执行
        enforce: 'pre',
        loader: 'eslint-loader',
        options: {
          fix: true
        }
      },
      {
        // 以下loader只会匹配一个
        // 注意：不能有两个配置处理同一种类型文件
        oneOf: [
          {
            test: /\.css$/,
            use: [...commonCssLoader]
          },
          {
            test: /\.less$/,
            use: [...commonCssLoader, 'less-loader']
          },
          /*
            正常来讲，一个文件只能被一个loader处理。
            当一个文件要被多个loader处理，那么一定要指定loader执行的先后顺序：
              先执行eslint 在执行babel
          */
          ,
          {
            test: /\.(jpg|png|gif)/,
            loader: 'url-loader',
            options: {
              limit: 8 * 1024,
              name: '[hash:10].[ext]',
              outputPath: 'imgs',
              esModule: false
            }
          },
          {
            test: /\.html$/,
            loader: 'html-loader'
          },
          {
            exclude: /\.(js|css|less|html|jpg|png|gif)/,
            loader: 'file-loader',
            options: {
              outputPath: 'media'
            }
          }
        ]
      }
    ]
  },
  plugins: [
    new MiniCssExtractPlugin({
      filename: 'css/built.[contenthash:10].css'
    }),
    new OptimizeCssAssetsWebpackPlugin(),
    new HtmlWebpackPlugin({
      template: './src/index.html',
      minify: {
        collapseWhitespace: true,
        removeComments: true
      }
    })
  ],
  mode: 'production',
  devtool: 'source-map'
}
```



### 多进程打包

### externals

### dll

## 优化运行的性能

### 缓存(hash-chunkhash-contenthash)

### tree shaking 

### code split

### 懒加载/预加载

### serveiceSockect pwa





 



